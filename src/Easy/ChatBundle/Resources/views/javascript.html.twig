<script>
  $(function() {
    var $form_chat = $('form.form-chat');
    var $input_send_message = $('input.send-message', $form_chat);
    var i_chat_loading = $('i.chat-loading');
    
    function scrollChatMessagesToBottom(force) {
      var $list_messages = $('.list-group.messages', '.list-group-chat');

      // On scrolle tout en bas seulement si on y est déjà (en cas d'ajout de message)
      if ($list_messages.scrollTop() == $list_messages.get(0).scrollHeight || force) {
        $list_messages.scrollTop($list_messages.get(0).scrollHeight);
      }
    }
    
    var refresh_interval;

    function enableRefreshInterval() {
      refresh_interval = setInterval(function() {
        i_chat_loading.show();
        
        $.ajax({
          url: '{{ path('chat_messages_get') }}',
          method: 'GET',
          success: function(response) {
            if (typeof response == 'string') {
              $('.list-group.messages', '.list-group-chat').html(response);

              scrollChatMessagesToBottom(false);
            } else {
              alert(response.message);
            }
          },
          complete: function() {
            i_chat_loading.hide();
          }
        });
      }, 10000);
    }
    
    function disableRefreshInterval() {
      clearInterval(refresh_interval);
    }

    // Si la souris rentre dans le chat, on arrête le refresh
    $('.list-group.messages', '.list-group-chat').on('mouseenter', function() {
      disableRefreshInterval();
    });
    
    // Si la souris sort du chat, on relance le refresh
    $('.list-group.messages', '.list-group-chat').on('mouseleave', function() {
      enableRefreshInterval();
    });
    
    // Nouveau message
    $form_chat.on('submit', function(e) {
      e.preventDefault();
      
      var $self = $(this);

      var data = $self.serialize();

      $input_send_message.prop('disabled', true);

      i_chat_loading.show();

      $.ajax({
        url: '{{ path('chat_message_new') }}',
        method: 'POST',
        data: data,
        success: function(response) {
          if (typeof response == 'string') {
            $('.list-group.messages', '.list-group-chat').append(response);

            scrollChatMessagesToBottom(true);

            $input_send_message.val('');
          } else {
            alert(response.message);
          }
        },
        complete: function() {
          i_chat_loading.hide();
          $input_send_message.prop('disabled', false).focus();
        }
      });
    });
    
    // Suppression d'un message
    $('.list-group-chat .list-group.messages').on('click', 'a.delete', function(e) {
      e.preventDefault();
      
      var $self = $(this);

      i_chat_loading.show();
      
      $.ajax({
        url: $self.attr('href'),
        method: 'DELETE',
        success: function(response) {
          if (typeof response == 'string') {
            var $list_messages = $('.list-group.messages', '.list-group-chat');

            $('.list-group-item[data-chat-message-id="'+$self.attr('data-chat-message-id')+'"]', $list_messages).replaceWith(response);
          } else {
            alert(response.message);
          }
        },
        complete: function() {
          i_chat_loading.hide();
        }
      });
    });

    // Annulation de la suppression d'un message
    $('.list-group-chat .list-group.messages').on('click', 'a.cancel-delete',  function(e) {
      e.preventDefault();

      var $self = $(this);

      i_chat_loading.show();

      $.ajax({
        url: $self.attr('href'),
        method: 'POST',
        success: function(response) {
          if (typeof response == 'string') {
            var $list_messages = $('.list-group.messages', '.list-group-chat');

            $('.list-group-item[data-chat-message-id="'+$self.attr('data-chat-message-id')+'"]', $list_messages).replaceWith(response);
          } else {
            alert(response.message);
          }
        },
        complete: function() {
          i_chat_loading.hide();
        }
      });
    });
    
    scrollChatMessagesToBottom(true); // Scroll du chat tout en bas
    enableRefreshInterval(); // Activation de l'actualisation auto
  });
</script>