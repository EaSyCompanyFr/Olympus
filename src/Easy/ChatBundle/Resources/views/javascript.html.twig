<script>
  $(function() {
    var $form_chat = $('form.form-chat');
    var $input_send_message = $('input.send-message', $form_chat);
    
    function scrollChatMessagesToBottom(force) {
      var $list_messages = $('.list-group.messages', '.list-group-chat');

      // On scrolle tout en bas seulement si on y est déjà (en cas d'ajout de message)
      if ($list_messages.scrollTop() == $list_messages.get(0).scrollHeight || force) {
        $list_messages.scrollTop($list_messages.get(0).scrollHeight);
      }
    }

    scrollChatMessagesToBottom(true);
    
    // Mise à jour du chat toutes les 15 secondes
    setInterval(function() {
      $.ajax({
        url: '{{ path('chat_messages_get') }}',
        method: 'GET',
        success: function(response) {
          if (typeof response == 'string') {
            $('.list-group.messages', '.list-group-chat').html(response);

            scrollChatMessagesToBottom(false);
          } else {
            alert(response.message);
          }
        }
      });
    }, 15000);
    
    // Nouveau message
    $form_chat.on('submit', function(e) {
      e.preventDefault();
      
      var $self = $(this);

      var data = $self.serialize();

      $input_send_message.prop('disabled', true);

      $.ajax({
        url: '{{ path('chat_message_new') }}',
        method: 'POST',
        data: data,
        success: function(response) {
          if (typeof response == 'string') {
            $('.list-group.messages', '.list-group-chat').append(response);

            scrollChatMessagesToBottom(false);

            $input_send_message.val('');
          } else {
            alert(response.message);
          }
        },
        complete: function() {
          $input_send_message.prop('disabled', false).focus();
        }
      });
    });
    
    // Suppression d'un message
    $('a.delete', '.list-group-chat .list-group.messages').on('click', function(e) {
      e.preventDefault();
      
      var $self = $(this);
      
      $.ajax({
        url: $self.attr('href'),
        method: 'DELETE',
        success: function(response) {
          if (typeof response == 'string') {
            var $list_messages = $('.list-group.messages', '.list-group-chat');

            $('.list-group-item[data-chat-message-id="'+$self.attr('data-chat-message-id')+'"]', $list_messages).replaceWith(response);
          } else {
            alert(response.message);
          }
        }
      });
    });

    // Annulation de la suppression d'un message
    $('a.cancel-delete', '.list-group-chat .list-group.messages').on('click', function(e) {
      e.preventDefault();

      var $self = $(this);

      $.ajax({
        url: $self.attr('href'),
        method: 'POST',
        success: function(response) {
          if (typeof response == 'string') {
            var $list_messages = $('.list-group.messages', '.list-group-chat');

            $('.list-group-item[data-chat-message-id="'+$self.attr('data-chat-message-id')+'"]', $list_messages).replaceWith(response);
          } else {
            alert(response.message);
          }
        }
      });
    });
  });
</script>