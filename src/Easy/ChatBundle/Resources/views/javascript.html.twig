<script>
  $(function() {
    var $form_chat = $('form.form-chat');
    var $input_send_message = $('input.send-message', $form_chat);
    var $list_messages = $('.list-group.messages', '.list-group-chat');

    $list_messages.scrollTop($list_messages.get(0).scrollHeight);
    
    // Mise à jour du chat toutes les 15 secondes
    setInterval(function() {
      $.ajax({
        url: '{{ path('chat_messages_get') }}',
        method: 'GET',
        success: function(response) {
          if (typeof response == 'string') {
            var $list_messages = $('.list-group.messages', '.list-group-chat');

            $list_messages.replaceWith(response);

            $list_messages = $('.list-group.messages', '.list-group-chat');

            $list_messages.scrollTop($list_messages.get(0).scrollHeight);
          } else {
            alert(response.message);
          }
        },
        error: function() {
          alert('Oups, impossible de récupérer les messages.');
        }
      });
    }, 15000);
    
    // Nouveau message
    $form_chat.on('submit', function(e) {
      e.preventDefault();
      
      var $self = $(this);

      var data = $self.serialize();

      $input_send_message.prop('disabled', true);

      $.ajax({
        url: '{{ path('chat_message_new') }}',
        method: 'POST',
        data: data,
        success: function(response) {
          if (typeof response == 'string') {
            var $list_messages = $('.list-group.messages', '.list-group-chat');

            $list_messages.append(response);

            $list_messages = $('.list-group.messages', '.list-group-chat');

            $list_messages.scrollTop($list_messages.get(0).scrollHeight);

            $input_send_message.val('');
          } else {
            alert(response.message);
          }
        },
        error: function() {
          alert('Oups, impossible d\'enregistrer votre message.');
        },
        complete: function() {
          $input_send_message.prop('disabled', false).focus();
        }
      });
    });
    
    // Suppression d'un message
    $('a.delete', '.list-group-chat .list-group.messages').on('click', function(e) {
      e.preventDefault();
      
      var $self = $(this);
      
      $.ajax({
        url: $self.attr('href'),
        method: 'DELETE',
        success: function(response) {
          if (typeof response == 'string') {
            var $list_messages = $('.list-group.messages', '.list-group-chat');

            $('.list-group-item[data-chat-message-id="'+$self.attr('data-chat-message-id')+'"]', $list_messages).replaceWith(response);
          } else {
            alert(response.message);
          }
        },
        error: function() {
          alert('Oups, impossible de supprimer ce message.');
        }
      });
    });

    // Annulation de la suppression d'un message
    $('a.cancel-delete', '.list-group-chat .list-group.messages').on('click', function(e) {
      e.preventDefault();

      var $self = $(this);

      $.ajax({
        url: $self.attr('href'),
        method: 'POST',
        success: function(response) {
          if (typeof response == 'string') {
            var $list_messages = $('.list-group.messages', '.list-group-chat');

            $('.list-group-item[data-chat-message-id="'+$self.attr('data-chat-message-id')+'"]', $list_messages).replaceWith(response);
          } else {
            alert(response.message);
          }
        },
        error: function() {
          alert('Oups, impossible d\'annuler la suppression de ce message.');
        }
      });
    });
  });
</script>